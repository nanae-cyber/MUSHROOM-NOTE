# オフライン同期機能のセットアップガイド

## 概要

このアプリは**オフラインファースト**で動作します：
- 山の中（オフライン）でも完全に動作
- Wi-Fi接続時に自動的にクラウドと同期
- 複数デバイス間でのデータ共有も可能

## セットアップ手順

### 1. Supabaseプロジェクトの作成

1. [Supabase](https://supabase.com)にアクセス
2. 「New Project」をクリック
3. プロジェクト名を入力（例: mushroom-note）
4. データベースパスワードを設定
5. リージョンを選択（日本なら Tokyo がおすすめ）
6. 「Create new project」をクリック

### 2. データベーステーブルの作成

1. Supabaseダッシュボードで「SQL Editor」を開く
2. `supabase-schema.sql`の内容をコピー＆ペースト
3. 「Run」をクリックして実行

### 3. メール認証の有効化

1. Supabaseダッシュボードで「Authentication」→「Providers」を開く
2. 「Email」を探してトグルをONにする
3. 「Save」をクリック
4. **確認メールの設定**:
   - 「Settings」タブをクリック
   - 「Enable email confirmations」をOFFにする（推奨）
   - 理由：確認メールがSupabaseドメインから送信されるため、ユーザーが怪しむ可能性がある

### 3-2. カスタムメールテンプレート（オプション）

確認メールを有効にする場合：

1. **Email Templates**を開く
2. 「Confirm signup」テンプレートを編集
3. 件名とメッセージをカスタマイズ
4. 送信元を設定（有料プランが必要）

### 4. 環境変数の設定

1. `.env.example`を`.env`にコピー:

```bash
cp .env.example .env
```

2. Supabaseダッシュボードで「Settings」→「API」を開く
3. 以下の値をコピーして`.env`に貼り付け:
   - `Project URL` → `VITE_SUPABASE_URL`
   - `anon public` key → `VITE_SUPABASE_ANON_KEY`

### 5. 動作確認

1. 開発サーバーを起動:
```bash
npm run dev
```

2. ブラウザでアプリを開く
3. ヘッダーに同期インジケーター（☁️アイコン）が表示されることを確認
4. 写真を撮影して、自動的に同期されることを確認

## 同期の仕組み

- **オフライン時**: IndexedDBに保存（今まで通り）
- **同期ON時**: 5分ごとに自動同期、Wi-Fi接続時に即座に同期
- **同期OFF時**: クラウドに送信せず、ローカルのみで動作
- **ON/OFF切り替え**: ヘッダーの「クラウド同期」ボタンをクリック

## 複数デバイス間での同期

1. **デバイスAでログイン**:
   - 「クラウド同期」ボタンをクリック
   - メールアドレスとパスワードでアカウント作成
   - データが自動的にクラウドに同期される

2. **デバイスBでログイン**:
   - 同じメールアドレスとパスワードでログイン
   - デバイスAのデータが自動的にダウンロードされる

3. **データの共有**:
   - 同じアカウントでログインすれば、すべてのデバイスでデータが同期される

## 有料プラン限定機能にする（オプション）

クラウド同期を有料プラン限定にする場合：

1. `src/ui/SyncIndicator.tsx`を開く
2. 以下のコメントを外す：
```typescript
const isPremium = localStorage.getItem('premium') === 'true';
if (!isPremium) {
  return null;
}
```

これで、無料ユーザーには同期ボタンが表示されなくなります。

## トラブルシューティング

### 同期が動作しない場合

1. `.env`ファイルが正しく設定されているか確認
2. ブラウザのコンソールでエラーを確認
3. Supabaseダッシュボードで匿名認証が有効か確認

### データが同期されない場合

1. ネットワーク接続を確認
2. 同期インジケーターをクリックして手動同期
3. ブラウザのコンソールでエラーログを確認

## オプション機能

### 同期設定なしで使う

`.env`ファイルを作成しなければ、オフラインのみで動作します。
